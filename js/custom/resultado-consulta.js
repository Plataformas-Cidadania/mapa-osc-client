"use strict";function getParameter(e,a){a||(a=location.href),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(a);return null==o?null:o[1]}var urlRota,type_http;require(["jquery-ui"],function(e){$(document).tooltip({position:{my:"center bottom-20",at:"center top",using:function(e,a){$(this).css(e),$("<div>").addClass("arrow").addClass(a.vertical).addClass(a.horizontal).appendTo(this)}}})}),require(["rotas","jquery-ui","datatables-responsive","leafletCluster","simplePagination"],function(e){var n,t,i={},l={},s={},c={},u=L.layerGroup(),d=L.layerGroup(),p=!1,r=!0,g=!1,m={},f="js/controller.php",o="",a={center:new L.LatLng(-16.55555555,-60.55555555),zoom:4,minZoom:4},h=new L.Map("map",a),_=new PruneClusterForLeaflet,v=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>'}),y=L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYW9zY3MiLCJhIjoiY2owbDJpYWxwMDM3dTMzbzh6dDU2bnpzdyJ9._dh2UCWnAeNeG0ZL5sQ5gA",{id:"mapbox.dark",attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'}),C=L.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});h.addLayer(C),h.addLayer(y),h.addLayer(v);var b,S=new L.Control.FullScreen;h.addControl(S);var x,O=new Rotas,R=void 0!==window.location.href.split("?")[1]?window.location.href.split("?")[1].split("="):null,T=$("#buscarPerfil .tab-content");function w(e){return e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/[ÀÁÂÃÄÅ]/g,"A")).replace(/[àáâãäå]/g,"a")).replace(/[ÉÈÊË]/g,"E")).replace(/[éèêë]/g,"e")).replace(/[ÍÌÎÏ]/g,"I")).replace(/[íìîï]/g,"i")).replace(/[ÓÒÔÕ]/g,"O")).replace(/[óòôõ]/g,"o")).replace(/[ÚÙÛÜ]/g,"U")).replace(/[úùûü]/g,"u")).replace(/[Ç]/g,"C")).replace(/[ç]/g,"c")}if(T.find(".btn.btn-primary").on("click",function(){var e=T.find(".tab-pane.fade.active.in"),a=e.attr("id"),o=e.find(".form-control").val();o=w(o.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,",").replace(/\+{2,}/g,"_"),"organizacao"==a&&""!==o?(t="./resultado-consulta.html?"+a+"="+o+"&tipoBusca=0",location.href=t):""!==(o=$(".response").val())?(t="./resultado-consulta.html?"+a+"="+o,location.href=t):$("#errorLabel").removeClass("hide")}),$("#organizacao .form-control").autocomplete({minLength:3,source:function(e,a){o=w(e.term.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:O.AutocompleteOSCByName(o,10,0)},success:function(e){a($.map(e,function(e){return{label:e.tx_nome_osc,value:e.tx_nome_osc,id:e.id_osc}}))},error:function(e){a([])}})},select:function(e,a){t="./resultado-consulta.html?organizacao="+w(a.item.value.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,",").replace(/\+{2,}/g,"_")+"&tipoBusca=1",location.href=t}}),$("#municipio .form-control").autocomplete({minLength:3,source:function(e,a){$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:O.AutocompleteOSCByCounty(w(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),25)},success:function(e){a($.map(e,function(e){return{label:e.edmu_nm_municipio+" - "+e.eduf_sg_uf,value:e.edmu_nm_municipio+" - "+e.eduf_sg_uf,id:e.edmu_cd_municipio}}))},error:function(e){a([])}})},select:function(e,a){$(".response").val(a.item.id),t="./resultado-consulta.html?municipio="+a.item.id,location.href=t}}),$("#estado .form-control").autocomplete({minLength:3,source:function(e,a){$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:O.AutocompleteOSCByState(w(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),10)},success:function(e){a($.map(e,function(e){return{label:e.eduf_nm_uf,value:e.eduf_nm_uf,id:e.eduf_cd_uf}}))},error:function(){a([])}})},select:function(e,a){$(".response").val(a.item.id),t="./resultado-consulta.html?estado="+a.item.id,location.href=t}}),$("#regiao .form-control").autocomplete({minLength:3,source:function(e,a){$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:O.AutocompleteOSCByRegion(w(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),10)},success:function(e){a($.map(e,function(e){return{label:e.edre_nm_regiao,value:e.edre_nm_regiao,id:e.edre_cd_regiao}}))},error:function(){a([])}})},select:function(e,a){$(".response").val(a.item.id),t="./resultado-consulta.html?regiao="+a.item.id,location.href=t}}),$(".ui-autocomplete-input").keypress(function(e){if(13==e.which)return $(".btn-primary").click(),$(".ui-menu-item").hide(),!1}),null!==R){x=R[0];var M=R[1];M=(M=M.replace(/\./g,"")).split("&")[0],"organizacao"==x?(urlRota=O.OSCByName(getParameter("organizacao"),0,getParameter("tipoBusca")),b=O.OSCByNameInMap(getParameter("organizacao"),getParameter("tipoBusca")),r=!1):"municipio"==x?(urlRota=O.OSCByCounty(M,0),b=O.OSCByCountyInMap(M),r=!1):"estado"==x?(urlRota=O.OSCByState(M,0),b=O.ClusterEstadoPorRegiao(M)):"regiao"==x?(urlRota=O.OSCByRegion(M,0),b=O.ClusterRegiao(M)):"avancado"==x?(m.avancado=window.localStorage.getItem("params_busca_avancada"),"{}"==m.avancado?(x="todos",b=O.ClusterPais(),urlRota=O.AllOSC(0)):(urlRota=O.ConsultaAvancadaLista(0),b=O.ConsultaAvancadaMapa(),g=!(r=!1))):console.log("ERRO de URL!")}else x="todos",b=O.ClusterPais(),urlRota=O.AllOSC(0);function j(e,a){var o;$("#loading").removeClass("hide"),$("#resultadoconsulta_formato_dados").hide(),a?(type_http="POST",o={flag:"consultaPost",rota:e,parametros:m}):(type_http="GET",o={flag:"consulta",rota:e}),$.ajax({url:"js/controller.php",type:type_http,dataType:"json",data:o,error:function(e){console.log("Erro no ajax: "+e)},success:function(e){if("Nenhuma Organização encontrada!"!==e){var a=e.length,o=new Array(a),t=0,r="Dado não informado.";for(var n in e)if("0"!=n){o[t]=new Array(6);var i=null!==e[n][4]?e[n][4]:"img/camera.jpg";o[t][0]='<img class="img-circle media-object" src='+i+' height="64" width="64">',o[t][1]=null!==e[n][0]?e[n][0]:r,o[t][2]=null!==e[n][1]?e[n][1]:r,o[t][3]=null!==e[n][2]?e[n][2]:r,o[t][4]=null!==e[n][3]?e[n][3]:r,o[t][5]='<button type="button" onclick="location.href=\'visualizar-osc.html#'+n+'\';" class="btn btn-info"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button>',t++}if(void 0!==o[0]){var l=$("#resultadoconsulta_formato_dados").DataTable({responsive:!0,processing:!0,deferLoading:1e3,deferRender:!0,searching:!1,data:o,dom:"Bfrtip",bPaginate:!1,bSort:!0,aaSorting:[[1,"asc"]],columns:[{title:"",width:50},{title:"Nome da OSC",width:200},{title:"CNPJ"},{title:"Natureza Jurídica"},{title:"Endereço"},{title:"Detalhar"}],aoColumnDefs:[{bSortable:!1,aTargets:[0]},{bSortable:!1,aTargets:[5]},{bSortable:!1,aTargets:[4]}],autoWidth:!0});l.destroy(),l.draw(),$("#resultadoconsulta_formato_dados").show(),$("#loading").addClass("hide")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==x&&"municipio"!==x?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(M)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==x&&"municipio"!==x?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(M)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}}),$("#resultadoconsulta_formato_dados").on("draw.dt",function(){verificarContraste()})}function A(e,a,o){if(""!==a&&null!==a||null!==o&&""!==o){var t=new PruneCluster.Marker(a,o);return t.data.ID=e,_.PrepareLeafletMarker=function(e,a){e.on("click",function(){var r,n;r=a.ID,(n=e).bindPopup('<img id="loading" src="img/loading.gif" style="padding-top: 10px; padding-left: 10px;"/>').openPopup(),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"consulta",rota:O.OSCPopUpByID(r)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(void 0!==e){var a=(null!==e.tx_endereco?e.tx_endereco:"")+" - "+(null!==e.tx_bairro?e.tx_bairro:""),o="Dado não informado.",t='<div class="mapa_organizacao clearfix"><span id="spantitle" class="magneticTooltip"><button id="title" class="btn-link"  onclick=location.href="visualizar-osc.html#'+r+'"><h4>'+(null!==e.tx_nome_osc?e.tx_nome_osc:o)+'</h4></button></span><div class="coluna1"><strong></strong><strong>Endereço: </strong>'+a+"<br><strong>Atividade Econômica: </strong>"+(null!==e.tx_nome_atividade_economica?e.tx_nome_atividade_economica:o)+"<br><strong>Natureza Jurídica: </strong>"+(null!==e.tx_nome_natureza_juridica?e.tx_nome_natureza_juridica:o)+'<br><br><div align="center"><button type = button class="btn btn-info" onclick=location.href="visualizar-osc.html#'+r+'"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button></div></div></div>';n.bindPopup(t).openPopup()}}})})},_.RegisterMarker(t),_}return null}function E(e,a,o,t,r){var n;if(""!==o&&null!==o||null!==t&&""!==t)return"regiao"==r||"todos"==r?n=L.marker([o,t],{icon:e}).on("click",J):"estado"==r&&(n=L.marker([o,t],{icon:e}).on("click",U)),n}function k(e){for(var a in e)if("0"!=a){var o=A(a,e[a][0],e[a][1]);null!==o&&h.addLayer(o)}$("#loadingMapModal").hide(),_.ProcessView()}var P,B=L.control();function z(e){var a=e.target;a.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||a.bringToFront(),"GO"==a.feature.properties.Name&&a.bringToBack(),B.update(a.feature.properties)}function D(e){n.resetStyle(e.target),B.update()}function q(e){var a=e.target;h.fitBounds(a.getBounds())}function I(a,o){var t;function r(e){var a,n,i,o=e.target;if(h.fitBounds(o.getBounds()),a=o.feature.properties.id,$("#loadingMapModal").show(),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"consulta",rota:O.OSCByStateInMap(a)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(j(urlRota,g),void 0!==e.length){for(var a=0,o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;F(a)}else F(Object.keys(e).length-1);void 0!==e&&k(e)}}),null==c[o.feature.properties.Regiao]){var t=s[o.feature.properties.id];null!=t&&h.removeLayer(t)}else i=(n=o).feature.properties.Regiao,$("#loadingMapModal").show(),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"consulta",rota:O.ClusterEstadoPorRegiao(i)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(j(urlRota,g),void 0!==e.length){for(var a=0,o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;F(a)}else F(Object.keys(e).length-1);if(void 0!==e){G(e,"estado");var t=c[i];h.removeLayer(t),delete c[i];var r=s[n.feature.properties.id];h.removeLayer(r)}}});o.off(),o.on({mouseover:z,mouseout:D,click:q})}$.each(statesData.features,function(e){t=statesData.features[e].properties.Name,statesData.features[e].properties.density=a[t],statesData.features[e].properties.id=o[t]}),h.addLayer(d),B.onAdd=function(e){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},B.update=function(e){this._div.innerHTML="<h4>OSCs por Estado</h4>"+(e?"<b>"+e.Name+"</b><br />"+e.density+" OSCs.":"Passe o mouse sobre um estado")},B.addTo(h);var e=L.control({position:"bottomright"});e.onAdd=function(e){var a=L.DomUtil.create("div","info legend"),o=[0,1e3,15e3,3e4,45e3,6e4];a.innerHTML+="<h5>Escala de OSCs por estado</h5>";for(var t=0;t<o.length;t++)a.innerHTML+='<i style="background:'+N(o[t]+1)+'"></i> '+parseInt(o[t]+1)+(o[t+1]?"&ndash;"+o[t+1]+"<br>":"+");return a},e.addTo(h),n=L.geoJson(statesData,{style:function(e){return{fillColor:N(e.properties.density),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.6}},onEachFeature:function(e,a){a.on({mouseover:z,mouseout:D,click:r}),d.addLayer(a),l[a.feature.properties.id]=a}}).addTo(h)}function N(e){return 6e4<e?"#800026":45e3<e?"#E31A1C":3e4<e?"#FC4E2A":15e3<e?"#FEB24C":1e3<e?"#FED976":"#FFEDA0"}function G(e,a){var o;for(var t in"regiao"==a||"todos"==a?o="labelClassRegiao":"estado"==a&&(o="labelClassEstado"),e){var r=L.divIcon({id:e[t].id_regiao,className:o,html:"<p>"+e[t].nr_quantidade_osc_regiao+"</p>"});i[e[t].id_regiao]=e[t].nr_quantidade_osc_regiao;var n=E(r,e[t].id_regiao,e[t].geo_lat_centroid_regiao,e[t].geo_lng_centroid_regiao,a);u.addLayer(n),"estado"==a?s[e[t].id_regiao]=n:"regiao"!=a&&"todos"!=a||(c[e[t].id_regiao]=n)}p||(u.addTo(h),p=!0),$("#loadingMapModal").hide()}function J(t){var r=t.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"consulta",rota:O.ClusterEstadoPorRegiao(r)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(j(urlRota,g),void 0!==e.length){for(var a=0,o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;F(a)}else F(Object.keys(e).length-1);void 0!==e&&(h.setView([t.target._latlng.lat,t.target._latlng.lng],5),h.removeLayer(t.target),delete c[r],G(e,"estado"))}})}function F(e){$(".pagination").pagination({items:e,itemsOnPage:10,hrefTextPrefix:"#",prevText:"Anterior",nextText:"Próximo",onPageClick:function(e){!function(e){null===e&&(e=0);var a=10*parseInt(e)-10;"avancado"==x?(urlRota=O.ConsultaAvancadaLista(a),g=!0):"municipio"==x?urlRota=O.OSCByCounty(M,a):"estado"==x?urlRota=O.OSCByState(M,a):"regiao"==x?urlRota=O.OSCByRegion(M,a):"todos"==x?urlRota=O.AllOSC(a):"organizacao"==x&&(urlRota=O.OSCByName(getParameter("organizacao"),a,getParameter("tipoBusca")));j(urlRota,g)}(e)}})}function U(r){var n=r.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"consulta",rota:O.OSCByStateInMap(n)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(j(urlRota,g),void 0!==e.length){for(var a=0,o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;F(a)}else F(Object.keys(e).length-1);if(void 0!==e){h.setView([r.target._latlng.lat,r.target._latlng.lng],6),h.removeLayer(r.target);var t=l[n];t.off(),t.on({mouseover:z,mouseout:D,click:q}),k(e)}}})}$("#loadingMapModal").show(),g?(type_http="POST",P={flag:"consultaPost",rota:b,parametros:m}):(type_http="GET",P={flag:"consulta",rota:b}),$.ajax({url:f,type:type_http,dataType:"json",data:P,error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(""!==e&&void 0!==e&&"Nenhuma Organização encontrada!"!==e){j(urlRota,g);var a=0;if(r){if(void 0!==e.length)for(var o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;F(a),$("#legenda p").append(a),G(e,x)}else F(a=Object.keys(e).length-1),$("#legenda p").append(a),k(e)}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==x&&"municipio"!==x?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(M)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}}),$.ajax({url:f,type:"GET",dataType:"json",data:{flag:"consulta",rota:O.ClusterEstado()},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(void 0!==e){var a={},o={};for(var t in e)a[e[t].tx_sigla_regiao]=e[t].nr_quantidade_osc_regiao,o[e[t].tx_sigla_regiao]=e[t].id_regiao;h.addControl(new L.Control.Layers({"Satélite":C,Contraste:y,Mapa:v},{"Mapa de calor":d},{collapsed:!1})),I(a,o)}}}),h.on("zoomend",function(e){18==h.getZoom()&&h.removeLayer(d)})});