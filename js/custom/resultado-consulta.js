"use strict";function getParameter(e,a){a||(a=location.href),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(a);return null==o?null:o[1]}var urlRota,type_http;require(["jquery-ui"],function(e){$(document).tooltip({position:{my:"center bottom-20",at:"center top",using:function(e,a){$(this).css(e),$("<div>").addClass("arrow").addClass(a.vertical).addClass(a.horizontal).appendTo(this)}}})}),require(["rotas","jquery-ui","datatables-responsive","leafletCluster","simplePagination"],function(e){var a,o,t={},r={},n={},i={},l=L.layerGroup(),s=L.layerGroup(),c=!1,u=!0,d=!1,p={},g="js/controller.php",m="",f=18,h={center:new L.LatLng(-16.55555555,-60.55555555),zoom:4,minZoom:4},_=new L.Map("map",h),v=new PruneClusterForLeaflet,y=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:f,attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>'}),C=L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYW9zY3MiLCJhIjoiY2owbDJpYWxwMDM3dTMzbzh6dDU2bnpzdyJ9._dh2UCWnAeNeG0ZL5sQ5gA",{id:"mapbox.dark",attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'}),b=L.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});_.addLayer(b),_.addLayer(C),_.addLayer(y);var S,x=new L.Control.FullScreen;_.addControl(x);var O,R=new Rotas,T=void 0!==window.location.href.split("?")[1]?window.location.href.split("?")[1].split("="):null,w=$("#buscarPerfil .tab-content");function M(e){return e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/[ÀÁÂÃÄÅ]/g,"A")).replace(/[àáâãäå]/g,"a")).replace(/[ÉÈÊË]/g,"E")).replace(/[éèêë]/g,"e")).replace(/[ÍÌÎÏ]/g,"I")).replace(/[íìîï]/g,"i")).replace(/[ÓÒÔÕ]/g,"O")).replace(/[óòôõ]/g,"o")).replace(/[ÚÙÛÜ]/g,"U")).replace(/[úùûü]/g,"u")).replace(/[Ç]/g,"C")).replace(/[ç]/g,"c")}if(w.find(".btn.btn-primary").on("click",function(){var e=w.find(".tab-pane.fade.active.in"),a=e.attr("id"),t=e.find(".form-control").val();t=M(t.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,",").replace(/\+{2,}/g,"_"),"organizacao"==a&&""!==t?(o="./resultado-consulta.html?"+a+"="+t+"&tipoBusca=0",location.href=o):""!==(t=$(".response").val())?(o="./resultado-consulta.html?"+a+"="+t,location.href=o):$("#errorLabel").removeClass("hide")}),$("#organizacao .form-control").autocomplete({minLength:3,source:function(e,a){m=M(e.term.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:R.AutocompleteOSCByName(m,10,0)},success:function(e){a($.map(e,function(e){return{label:e.tx_nome_osc,value:e.tx_nome_osc,id:e.id_osc}}))},error:function(e){a([])}})},select:function(e,a){o="./resultado-consulta.html?organizacao="+M(a.item.value.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,",").replace(/\+{2,}/g,"_")+"&tipoBusca=1",location.href=o}}),$("#municipio .form-control").autocomplete({minLength:3,source:function(e,a){$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:R.AutocompleteOSCByCounty(M(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),25)},success:function(e){a($.map(e,function(e){return{label:e.edmu_nm_municipio+" - "+e.eduf_sg_uf,value:e.edmu_nm_municipio+" - "+e.eduf_sg_uf,id:e.edmu_cd_municipio}}))},error:function(e){a([])}})},select:function(e,a){$(".response").val(a.item.id),o="./resultado-consulta.html?municipio="+a.item.id,location.href=o}}),$("#estado .form-control").autocomplete({minLength:3,source:function(e,a){$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:R.AutocompleteOSCByState(M(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),10)},success:function(e){a($.map(e,function(e){return{label:e.eduf_nm_uf,value:e.eduf_nm_uf,id:e.eduf_cd_uf}}))},error:function(){a([])}})},select:function(e,a){$(".response").val(a.item.id),o="./resultado-consulta.html?estado="+a.item.id,location.href=o}}),$("#regiao .form-control").autocomplete({minLength:3,source:function(e,a){$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:R.AutocompleteOSCByRegion(M(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),10)},success:function(e){a($.map(e,function(e){return{label:e.edre_nm_regiao,value:e.edre_nm_regiao,id:e.edre_cd_regiao}}))},error:function(){a([])}})},select:function(e,a){$(".response").val(a.item.id),o="./resultado-consulta.html?regiao="+a.item.id,location.href=o}}),$(".ui-autocomplete-input").keypress(function(e){if(13==e.which)return $(".btn-primary").click(),$(".ui-menu-item").hide(),!1}),null!==T){O=T[0];var j=T[1];j=(j=j.replace(/\./g,"")).split("&")[0],"organizacao"==O?(urlRota=R.OSCByName(getParameter("organizacao"),0,getParameter("tipoBusca")),S=R.OSCByNameInMap(getParameter("organizacao"),getParameter("tipoBusca")),u=!1):"municipio"==O?(urlRota=R.OSCByCounty(j,0),S=R.OSCByCountyInMap(j),u=!1):"estado"==O?(urlRota=R.OSCByState(j,0),S=R.ClusterEstadoPorRegiao(j)):"regiao"==O?(urlRota=R.OSCByRegion(j,0),S=R.ClusterRegiao(j)):"avancado"==O?(p.avancado=window.localStorage.getItem("params_busca_avancada"),"{}"==p.avancado?(O="todos",S=R.ClusterPais(),urlRota=R.AllOSC(0)):(urlRota=R.ConsultaAvancadaLista(0),S=R.ConsultaAvancadaMapa(),u=!1,d=!0)):console.log("ERRO de URL!")}else O="todos",S=R.ClusterPais(),urlRota=R.AllOSC(0);function A(e,a){var o;$("#loading").removeClass("hide"),$("#resultadoconsulta_formato_dados").hide(),a?(type_http="POST",o={flag:"consultaPost",rota:e,parametros:p}):(type_http="GET",o={flag:"consulta",rota:e}),$.ajax({url:"js/controller.php",type:type_http,dataType:"json",data:o,error:function(e){console.log("Erro no ajax: "+e)},success:function(e){if("Nenhuma Organização encontrada!"!==e){var a=e.length,o=new Array(a),t=0,r="Dado não informado.";for(var n in e)if("0"!=n){o[t]=new Array(6);var i=null!==e[n][4]?e[n][4]:"img/camera.jpg";o[t][0]='<img class="img-circle media-object" src='+i+' height="64" width="64">',o[t][1]=null!==e[n][0]?e[n][0]:r,o[t][2]=null!==e[n][1]?e[n][1]:r,o[t][3]=null!==e[n][2]?e[n][2]:r,o[t][4]=null!==e[n][3]?e[n][3]:r,o[t][5]='<button type="button" onclick="location.href=\'visualizar-osc.html#'+n+'\';" class="btn btn-info"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button>',t++}if(void 0!==o[0]){var l=$("#resultadoconsulta_formato_dados").DataTable({responsive:!0,processing:!0,deferLoading:1e3,deferRender:!0,searching:!1,data:o,dom:"Bfrtip",bPaginate:!1,bSort:!0,aaSorting:[[1,"asc"]],columns:[{title:"",width:50},{title:"Nome da OSC",width:200},{title:"CNPJ"},{title:"Natureza Jurídica"},{title:"Endereço"},{title:"Detalhar"}],aoColumnDefs:[{bSortable:!1,aTargets:[0]},{bSortable:!1,aTargets:[5]},{bSortable:!1,aTargets:[4]}],autoWidth:!0});l.destroy(),l.draw(),$("#resultadoconsulta_formato_dados").show(),$("#loading").addClass("hide")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==O&&"municipio"!==O?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(j)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==O&&"municipio"!==O?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(j)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}}),$("#resultadoconsulta_formato_dados").on("draw.dt",function(){verificarContraste()})}function E(e,a,o){if(""!==a&&null!==a||null!==o&&""!==o){var t=new PruneCluster.Marker(a,o);return t.data.ID=e,v.PrepareLeafletMarker=function(e,a){e.on("click",function(){var o,t;o=a.ID,(t=e).bindPopup('<img id="loading" src="img/loading.gif" style="padding-top: 10px; padding-left: 10px;"/>').openPopup(),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"consulta",rota:R.OSCPopUpByID(o)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(void 0!==e){var a=(null!==e.tx_endereco?e.tx_endereco:"")+" - "+(null!==e.tx_bairro?e.tx_bairro:""),r="Dado não informado.",n='<div class="mapa_organizacao clearfix"><span id="spantitle" class="magneticTooltip"><button id="title" class="btn-link"  onclick=location.href="visualizar-osc.html#'+o+'"><h4>'+(null!==e.tx_nome_osc?e.tx_nome_osc:r)+'</h4></button></span><div class="coluna1"><strong></strong><strong>Endereço: </strong>'+a+"<br><strong>Atividade Econômica: </strong>"+(null!==e.tx_nome_atividade_economica?e.tx_nome_atividade_economica:r)+"<br><strong>Natureza Jurídica: </strong>"+(null!==e.tx_nome_natureza_juridica?e.tx_nome_natureza_juridica:r)+'<br><br><div align="center"><button type = button class="btn btn-info" onclick=location.href="visualizar-osc.html#'+o+'"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button></div></div></div>';t.bindPopup(n).openPopup()}}})})},v.RegisterMarker(t),v}return null}function k(e,a,o,t,r){var n;if(""!==o&&null!==o||null!==t&&""!==t)return"regiao"==r||"todos"==r?n=L.marker([o,t],{icon:e}).on("click",F):"estado"==r&&(n=L.marker([o,t],{icon:e}).on("click",X)),n}function P(e){for(var a in e)if("0"!=a){var o=E(a,e[a][0],e[a][1]);null!==o&&_.addLayer(o)}$("#loadingMapModal").hide(),v.ProcessView()}var B,z=L.control();function D(e){var a=e.target;a.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||a.bringToFront(),"GO"==a.feature.properties.Name&&a.bringToBack(),z.update(a.feature.properties)}function q(e){a.resetStyle(e.target),z.update()}function I(e){var a=e.target;_.fitBounds(a.getBounds())}function N(e,o){var t;function l(e){var a,o,t,r=e.target;if(_.fitBounds(r.getBounds()),a=r.feature.properties.id,$("#loadingMapModal").show(),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"consulta",rota:R.OSCByStateInMap(a)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(A(urlRota,d),void 0!==e.length){for(var a=0,o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;U(a)}else U(Object.keys(e).length-1);void 0!==e&&P(e)}}),void 0==i[r.feature.properties.Regiao]){var l=n[r.feature.properties.id];void 0!=l&&_.removeLayer(l)}else t=(o=r).feature.properties.Regiao,$("#loadingMapModal").show(),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"consulta",rota:R.ClusterEstadoPorRegiao(t)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(A(urlRota,d),void 0!==e.length){for(var a=0,r=0;r<e.length;r++)a+=e[r].nr_quantidade_osc_regiao;U(a)}else U(Object.keys(e).length-1);if(void 0!==e){J(e,"estado");var l=i[t];_.removeLayer(l),delete i[t];var s=n[o.feature.properties.id];_.removeLayer(s)}}});r.off(),r.on({mouseover:D,mouseout:q,click:I})}$.each(statesData.features,function(a){t=statesData.features[a].properties.Name,statesData.features[a].properties.density=e[t],statesData.features[a].properties.id=o[t]}),_.addLayer(s),z.onAdd=function(e){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},z.update=function(e){this._div.innerHTML="<h4>OSCs por Estado</h4>"+(e?"<b>"+e.Name+"</b><br />"+e.density+" OSCs.":"Passe o mouse sobre um estado")},z.addTo(_);var c=L.control({position:"bottomright"});c.onAdd=function(e){var a=L.DomUtil.create("div","info legend"),o=[0,1e3,15e3,3e4,45e3,6e4];a.innerHTML+="<h5>Escala de OSCs por estado</h5>";for(var t=0;t<o.length;t++)a.innerHTML+='<i style="background:'+G(o[t]+1)+'"></i> '+parseInt(o[t]+1)+(o[t+1]?"&ndash;"+o[t+1]+"<br>":"+");return a},c.addTo(_),a=L.geoJson(statesData,{style:function(e){return{fillColor:G(e.properties.density),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.6}},onEachFeature:function(e,a){a.on({mouseover:D,mouseout:q,click:l}),s.addLayer(a),r[a.feature.properties.id]=a}}).addTo(_)}function G(e){return e>6e4?"#800026":e>45e3?"#E31A1C":e>3e4?"#FC4E2A":e>15e3?"#FEB24C":e>1e3?"#FED976":"#FFEDA0"}function J(e,a){var o;for(var r in"regiao"==a||"todos"==a?o="labelClassRegiao":"estado"==a&&(o="labelClassEstado"),e){var s=L.divIcon({id:e[r].id_regiao,className:o,html:"<p>"+e[r].nr_quantidade_osc_regiao+"</p>"});t[e[r].id_regiao]=e[r].nr_quantidade_osc_regiao;var u=k(s,e[r].id_regiao,e[r].geo_lat_centroid_regiao,e[r].geo_lng_centroid_regiao,a);l.addLayer(u),"estado"==a?n[e[r].id_regiao]=u:"regiao"!=a&&"todos"!=a||(i[e[r].id_regiao]=u)}c||(l.addTo(_),c=!0),$("#loadingMapModal").hide()}function F(e){var a=e.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"consulta",rota:R.ClusterEstadoPorRegiao(a)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(o){if(A(urlRota,d),void 0!==o.length){for(var t=0,r=0;r<o.length;r++)t+=o[r].nr_quantidade_osc_regiao;U(t)}else U(Object.keys(o).length-1);void 0!==o&&(_.setView([e.target._latlng.lat,e.target._latlng.lng],5),_.removeLayer(e.target),delete i[a],J(o,"estado"))}})}function U(e){$(".pagination").pagination({items:e,itemsOnPage:10,hrefTextPrefix:"#",prevText:"Anterior",nextText:"Próximo",onPageClick:function(e){!function(e){null===e&&(e=0);var a=10*parseInt(e)-10;"avancado"==O?(urlRota=R.ConsultaAvancadaLista(a),d=!0):"municipio"==O?urlRota=R.OSCByCounty(j,a):"estado"==O?urlRota=R.OSCByState(j,a):"regiao"==O?urlRota=R.OSCByRegion(j,a):"todos"==O?urlRota=R.AllOSC(a):"organizacao"==O&&(urlRota=R.OSCByName(getParameter("organizacao"),a,getParameter("tipoBusca")));A(urlRota,d)}(e)}})}function X(e){var a=e.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"consulta",rota:R.OSCByStateInMap(a)},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(o){if(A(urlRota,d),void 0!==o.length){for(var t=0,n=0;n<o.length;n++)t+=o[n].nr_quantidade_osc_regiao;U(t)}else U(Object.keys(o).length-1);if(void 0!==o){_.setView([e.target._latlng.lat,e.target._latlng.lng],6),_.removeLayer(e.target);var i=r[a];i.off(),i.on({mouseover:D,mouseout:q,click:I}),P(o)}}})}$("#loadingMapModal").show(),d?(type_http="POST",B={flag:"consultaPost",rota:S,parametros:p}):(type_http="GET",B={flag:"consulta",rota:S}),$.ajax({url:g,type:type_http,dataType:"json",data:B,error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(""!==e&&void 0!==e&&"Nenhuma Organização encontrada!"!==e){A(urlRota,d);var a=0;if(u){if(void 0!==e.length)for(var o=0;o<e.length;o++)a+=e[o].nr_quantidade_osc_regiao;U(a),$("#legenda p").append(a),J(e,O)}else U(a=Object.keys(e).length-1),$("#legenda p").append(a),P(e)}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==O&&"municipio"!==O?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(j)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}}),$.ajax({url:g,type:"GET",dataType:"json",data:{flag:"consulta",rota:R.ClusterEstado()},error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(void 0!==e){var a={},o={};for(var t in e)a[e[t].tx_sigla_regiao]=e[t].nr_quantidade_osc_regiao,o[e[t].tx_sigla_regiao]=e[t].id_regiao;_.addControl(new L.Control.Layers({"Satélite":b,Contraste:C,Mapa:y},{"Mapa de calor":s},{collapsed:!1})),N(a,o)}}}),_.on("zoomend",function(e){_.getZoom()==f&&_.removeLayer(s)})});