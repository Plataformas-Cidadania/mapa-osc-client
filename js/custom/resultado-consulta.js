"use strict";function getParameter(a,e){e||(e=location.href);var o="[\\?&]"+(a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",t=new RegExp(o).exec(e);return null==t?null:t[1]}require(["jquery-ui"],function(a){$(document).tooltip({position:{my:"center bottom-20",at:"center top",using:function(a,e){$(this).css(a),$("<div>").addClass("arrow").addClass(e.vertical).addClass(e.horizontal).appendTo(this)}}})});var urlRota;require(["rotas","jquery-ui","datatables-responsive","leafletCluster","simplePagination"],function(a){function e(a){return a=a.replace(/[ÀÁÂÃÄÅ]/g,"A"),a=a.replace(/[àáâãäå]/g,"a"),a=a.replace(/[ÉÈÊË]/g,"E"),a=a.replace(/[éèêë]/g,"e"),a=a.replace(/[ÍÌÎÏ]/g,"I"),a=a.replace(/[íìîï]/g,"i"),a=a.replace(/[ÓÒÔÕ]/g,"O"),a=a.replace(/[óòôõ]/g,"o"),a=a.replace(/[ÚÙÛÜ]/g,"U"),a=a.replace(/[úùûü]/g,"u"),a=a.replace(/[Ç]/g,"C"),a=a.replace(/[ç]/g,"c")}function o(a){$("#loading").removeClass("hide"),$("#resultadoconsulta_formato_dados").hide(),$.ajax({url:"js/controller.php",type:"GET",dataType:"json",data:{flag:"consulta",rota:a},error:function(a){console.log("Erro no ajax: "+a)},success:function(a){var e=a.length;z=new Array(e);var o=0,t="Dado não informado.";for(var r in a)"0"!=r&&(z[o]=new Array(6),srcImg=null!==a[r][4]?a[r][4]:"img/camera.jpg",z[o][0]='<img class="img-circle media-object" src='+srcImg+' height="64" width="64">',z[o][1]=null!==a[r][0]?a[r][0]:t,z[o][2]=null!==a[r][1]?a[r][1]:t,z[o][3]=null!==a[r][2]?a[r][2]:t,z[o][4]=null!==a[r][3]?a[r][3]:t,z[o][5]='<button type="button" onclick="location.href=\'visualizar-osc.html#'+r+'\';" class="btn btn-info"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button>',o++);if(void 0!==z[0]){var n=$("#resultadoconsulta_formato_dados").DataTable({responsive:!0,processing:!0,deferLoading:1e3,deferRender:!0,searching:!1,data:z,dom:"Bfrtip",bPaginate:!1,bSort:!0,aaSorting:[[1,"asc"]],columns:[{title:"",width:50},{title:"Nome da OSC",width:200},{title:"CNPJ"},{title:"Natureza Jurídica"},{title:"Endereço"},{title:"Detalhar"}],aoColumnDefs:[{bSortable:!1,aTargets:[0]},{bSortable:!1,aTargets:[5]},{bSortable:!1,aTargets:[4]}],autoWidth:!0});n.destroy(),n.draw(),$("#resultadoconsulta_formato_dados").show(),$("#loading").addClass("hide")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada"),$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(J)+'" não retornou nenhuma OSC.'),$("#modalMensagem").modal("show")}}),$("#resultadoconsulta_formato_dados").on("draw.dt",function(){verificarContraste()})}function t(a,e){e.bindPopup('<img id="loading" src="img/loading.gif" style="padding-top: 10px; padding-left: 10px;"/>').openPopup(),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:I.OSCPopUpByID(a)},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(o){if(void 0!==o){var t=(null!==o.tx_endereco?o.tx_endereco:"")+" - "+(null!==o.tx_bairro?o.tx_bairro:""),r='<div class="mapa_organizacao clearfix"><span id="spantitle" class="magneticTooltip"><button id="title" class="btn-link" title="Clique para Detalhar" onclick=location.href="visualizar-osc.html#'+a+'"><h4>'+(null!==o.tx_nome_osc?o.tx_nome_osc:"Dado não informado.")+'</h4></button></span><div class="coluna1"><strong></strong><strong>Endereço: </strong>'+t+"<br><strong>Atividade Econômica: </strong>"+(null!==o.tx_nome_atividade_economica?o.tx_nome_atividade_economica:"Dado não informado.")+"<br><strong>Natureza Jurídica: </strong>"+(null!==o.tx_nome_natureza_juridica?o.tx_nome_natureza_juridica:"Dado não informado.")+'<br><br><div align="center"><button type = button class="btn btn-info" title="Clique para Detalhar" onclick=location.href="visualizar-osc.html#'+a+'"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button></div></div></div>';e.bindPopup(r).openPopup()}}})}function r(a,e,o){if(""!==e&&null!==e||null!==o&&""!==o){var r=new PruneCluster.Marker(e,o);return r.data.ID=a,w.PrepareLeafletMarker=function(a,e){a.on("click",function(){t(e.ID,a)})},w.RegisterMarker(r),w}return null}function n(a,e,o,t,r){if(""!==o&&null!==o||null!==t&&""!==t){var n;return"regiao"==r||"todos"==r?n=L.marker([o,t],{icon:a}).on("click",m):"estado"==r&&(n=L.marker([o,t],{icon:a}).on("click",v)),n}}function i(a){for(var e in a){var o=r(e,a[e][0],a[e][1]);null!==o&&map.addLayer(o)}$("#loadingMapModal").hide(),w.ProcessView()}function l(a){var e=a.target;e.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||e.bringToFront(),"GO"==e.feature.properties.Name&&e.bringToBack(),N.update(e.feature.properties)}function s(a){_.resetStyle(a.target),N.update()}function c(a){var e=a.target;map.fitBounds(e.getBounds())}function d(a,e){function o(a){var e=a.target;if(map.fitBounds(e.getBounds()),g(e.feature.properties.id),void 0==rlayers[e.feature.properties.Regiao]){var o=clayers[e.feature.properties.id];void 0!=o&&map.removeLayer(o)}else f(e);e.off(),e.on({mouseover:l,mouseout:s,click:c})}$.each(statesData.features,function(o){nomeEstado=statesData.features[o].properties.Name,statesData.features[o].properties.density=a[nomeEstado],statesData.features[o].properties.id=e[nomeEstado]}),map.addLayer(C),N.onAdd=function(a){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},N.update=function(a){this._div.innerHTML="<h4>OSCs por Estado</h4>"+(a?"<b>"+a.Name+"</b><br />"+a.density+" OSCs.":"Passe o mouse sobre um estado")},N.addTo(map);var t=L.control({position:"bottomright"});t.onAdd=function(a){var e=L.DomUtil.create("div","info legend"),o=[0,1e3,15e3,3e4,45e3,6e4];e.innerHTML+="<h5>Escala de OSCs por estado</h5>";for(var t=0;t<o.length;t++)e.innerHTML+='<i style="background:'+u(o[t]+1)+'"></i> '+parseInt(o[t]+1)+(o[t+1]?"&ndash;"+o[t+1]+"<br>":"+");return e},t.addTo(map),_=L.geoJson(statesData,{style:function(a){return{fillColor:u(a.properties.density),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.6}},onEachFeature:function(a,e){e.on({mouseover:l,mouseout:s,click:o}),C.addLayer(e),llayers[e.feature.properties.id]=e}}).addTo(map)}function u(a){return a>6e4?"#800026":a>45e3?"#E31A1C":a>3e4?"#FC4E2A":a>15e3?"#FEB24C":a>1e3?"#FED976":"#FFEDA0"}function p(a,e){var o;"regiao"==e||"todos"==e?o="labelClassRegiao":"estado"==e&&(o="labelClassEstado");for(var t in a){var r=L.divIcon({id:a[t].id_regiao,className:o,html:"<p>"+a[t].nr_quantidade_osc_regiao+"</p>"});b[a[t].id_regiao]=a[t].nr_quantidade_osc_regiao;var i=n(r,a[t].id_regiao,a[t].geo_lat_centroid_regiao,a[t].geo_lng_centroid_regiao,e);clustersLayer.addLayer(i),"estado"==e?clayers[a[t].id_regiao]=i:"regiao"!=e&&"todos"!=e||(rlayers[a[t].id_regiao]=i)}x||(clustersLayer.addTo(map),x=!0),$("#loadingMapModal").hide()}function g(a){$("#loadingMapModal").show(),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:I.OSCByStateInMap(a)},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(a){if(o(urlRota),void 0!==a.length){for(var e=0,t=0;t<a.length;t++)e+=a[t].nr_quantidade_osc_regiao;y(e)}else y(Object.keys(a).length-1);void 0!==a&&i(a)}})}function m(a){var e=a.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:I.ClusterEstadoPorRegiao(e)},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(t){if(o(urlRota),void 0!==t.length){for(var r=0,n=0;n<t.length;n++)r+=t[n].nr_quantidade_osc_regiao;y(r)}else y(Object.keys(t).length-1);void 0!==t&&(map.setView([a.target._latlng.lat,a.target._latlng.lng],5),map.removeLayer(a.target),delete rlayers[e],p(t,"estado"))}})}function f(a){var e=a.feature.properties.Regiao;$("#loadingMapModal").show(),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:I.ClusterEstadoPorRegiao(e)},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(t){if(o(urlRota),void 0!==t.length){for(var r=0,n=0;n<t.length;n++)r+=t[n].nr_quantidade_osc_regiao;y(r)}else y(Object.keys(t).length-1);if(void 0!==t){p(t,"estado");var i=rlayers[e];map.removeLayer(i),delete rlayers[e];var l=clayers[a.feature.properties.id];map.removeLayer(l)}}})}function y(a){$(".pagination").pagination({items:a,itemsOnPage:10,hrefTextPrefix:"#",prevText:"Anterior",nextText:"Próximo",onPageClick:function(a){h(a)}})}function h(a){null===a&&(a=0);var e=10*parseInt(a)-10;"avancado"==D?urlRota=I.ConsultaAvancadaLista(J,e):"municipio"==D?urlRota=I.OSCByCounty(J,e):"estado"==D?urlRota=I.OSCByState(J,e):"regiao"==D?urlRota=I.OSCByRegion(J,e):"todos"==D?urlRota=I.AllOSC(e):"organizacao"==D&&(urlRota=I.OSCByName(getParameter("organizacao"),e,getParameter("similaridade"))),o(urlRota)}function v(a){var e=a.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:I.OSCByStateInMap(e)},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(t){if(o(urlRota),void 0!==t.length){for(var r=0,n=0;n<t.length;n++)r+=t[n].nr_quantidade_osc_regiao;y(r)}else y(Object.keys(t).length-1);if(void 0!==t){map.setView([a.target._latlng.lat,a.target._latlng.lng],6),map.removeLayer(a.target);var d=llayers[e];d.off(),d.on({mouseover:l,mouseout:s,click:c}),i(t)}}})}var _,b={};llayers={},clayers={},rlayers={},clustersLayer=L.layerGroup();var C=L.layerGroup(),x=!1,R=!0,O="js/controller.php",S=!0,T="",E=18,j={center:new L.LatLng(-16.55555555,-60.55555555),zoom:4,minZoom:4};map=new L.Map("map",j);var w=new PruneClusterForLeaflet,k=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:E,attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>'}),A=L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYW9zY3MiLCJhIjoiY2owbDJpYWxwMDM3dTMzbzh6dDU2bnpzdyJ9._dh2UCWnAeNeG0ZL5sQ5gA",{id:"mapbox.dark",attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'}),M=L.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});map.addLayer(M),map.addLayer(A),map.addLayer(k);var P=new L.Control.FullScreen;map.addControl(P);var z,B,D,I=new Rotas,G=void 0!==window.location.href.split("?")[1]?window.location.href.split("?")[1].split("="):null,q=$("#buscarPerfil .tab-content");if(q.find(".btn.btn-primary").on("click",function(){var a=q.find(".tab-pane.fade.active.in"),o=a.attr("id"),t=a.find(".form-control").val();t=e(t.trim()).replace(/[ -]/g,"+").replace(/\+{2,}/g,"+");var r;"organizacao"==o&&""!==t?(r="./resultado-consulta.html?"+o+"="+t+"&similaridade=05",location.href=r):""!==(t=$(".response").val())?(r="./resultado-consulta.html?"+o+"="+t,location.href=r):$("#errorLabel").removeClass("hide")}),$("#organizacao .form-control").autocomplete({minLength:3,source:function(a,o){T=e(a.term.trim()).replace(/ /g,"+"),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:I.AutocompleteOSCByName(T,10,"05")},success:function(a){a.constructor===Array&&1==a.length&&(a[0].bo_multiple||(S=!1)),o($.map(a,function(a){return{label:a.tx_nome_osc,value:a.tx_nome_osc,id:a.id_osc}}))},error:function(a){o([])}})},select:function(a,o){link=S?"./resultado-consulta.html?organizacao="+e(o.item.value.trim()).replace(/[ -]/g,"+").replace(/\+{2,}/g,"+")+"&similaridade=99":"./resultado-consulta.html?organizacao="+e(T.trim()).replace(/[ -]/g,"+").replace(/\+{2,}/g,"+")+"&similaridade=05",location.href=link}}),$("#municipio .form-control").autocomplete({minLength:3,source:function(a,o){$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:I.AutocompleteOSCByCounty(e(a.term).replace(/ /g,"+"),25)},success:function(a){o($.map(a,function(a){return{label:a.edmu_nm_municipio+" - "+a.eduf_sg_uf,value:a.edmu_nm_municipio+" - "+a.eduf_sg_uf,id:a.edmu_cd_municipio}}))},error:function(a){o([])}})},select:function(a,e){$(".response").val(e.item.id),link="./resultado-consulta.html?municipio="+e.item.id,location.href=link}}),$("#estado .form-control").autocomplete({minLength:3,source:function(a,o){$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:I.AutocompleteOSCByState(e(a.term).replace(/ /g,"+"),10)},success:function(a){o($.map(a,function(a){return{label:a.eduf_nm_uf,value:a.eduf_nm_uf,id:a.eduf_cd_uf}}))},error:function(){o([])}})},select:function(a,e){$(".response").val(e.item.id),link="./resultado-consulta.html?estado="+e.item.id,location.href=link}}),$("#regiao .form-control").autocomplete({minLength:3,source:function(a,o){$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"autocomplete",rota:I.AutocompleteOSCByRegion(e(a.term).replace(/ /g,"+"),10)},success:function(a){o($.map(a,function(a){return{label:a.edre_nm_regiao,value:a.edre_nm_regiao,id:a.edre_cd_regiao}}))},error:function(){o([])}})},select:function(a,e){$(".response").val(e.item.id),link="./resultado-consulta.html?regiao="+e.item.id,location.href=link}}),$(".ui-autocomplete-input").keypress(function(a){if(13==a.which)return $(".btn-primary").click(),$(".ui-menu-item").hide(),!1}),null!==G){D=G[0];var J=G[1];J=J.replace(/\./g,""),J=J.split("&")[0],window.location.href.indexOf("organizacao")>-1?(urlRota=I.OSCByName(getParameter("organizacao"),0,getParameter("similaridade")),B=I.OSCByNameInMap(getParameter("organizacao"),getParameter("similaridade")),R=!1):"municipio"==D?(urlRota=I.OSCByCounty(J,0),B=I.OSCByCountyInMap(J),R=!1):"estado"==D?(urlRota=I.OSCByState(J,0),B=I.ClusterEstadoPorRegiao(J)):"regiao"==D?(urlRota=I.OSCByRegion(J,0),B=I.ClusterRegiao(J)):"avancado"==D?"{}"==J?(D="todos",B=I.ClusterPais(),urlRota=I.AllOSC(0)):(urlRota=I.ConsultaAvancadaLista(J,0),B=I.ConsultaAvancadaMapa(J),R=!1):console.log("ERRO de URL!")}else D="todos",B=I.ClusterPais(),urlRota=I.AllOSC(0);var N=L.control();$("#loadingMapModal").show(),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:B},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(a){if(void 0!==a){if(o(urlRota),void 0!==a.length){for(var e=0,t=0;t<a.length;t++)e+=a[t].nr_quantidade_osc_regiao;y(e),$("#legenda p").append(e)}else y(Object.keys(a).length-1),$("#legenda p").append(Object.keys(a).length-1);R?p(a,D):i(a)}}}),$.ajax({url:O,type:"GET",dataType:"json",data:{flag:"consulta",rota:I.ClusterEstado()},error:function(a){console.log("ERRO no AJAX :"+a)},success:function(a){if(void 0!==a){var e={},o={};for(var t in a)e[a[t].tx_sigla_regiao]=a[t].nr_quantidade_osc_regiao,o[a[t].tx_sigla_regiao]=a[t].id_regiao;map.addControl(new L.Control.Layers({"Satélite":M,Contraste:A,Mapa:k},{"Mapa de calor":C},{collapsed:!1})),d(e,o)}}}),map.on("zoomend",function(a){map.getZoom()==E&&map.removeLayer(C)})});