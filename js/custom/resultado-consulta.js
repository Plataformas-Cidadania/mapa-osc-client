"use strict";function getParameter(e,a){a||(a=location.href);var o="[\\?&]"+(e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",t=new RegExp(o).exec(a);return null==t?null:t[1]}require(["jquery-ui"],function(e){$(document).tooltip({position:{my:"center bottom-20",at:"center top",using:function(e,a){$(this).css(e),$("<div>").addClass("arrow").addClass(a.vertical).addClass(a.horizontal).appendTo(this)}}})});var urlRota,type_http;require(["rotas","jquery-ui","datatables-responsive","leafletCluster","simplePagination"],function(e){function a(e){return e=e.replace(/[ÀÁÂÃÄÅ]/g,"A"),e=e.replace(/[àáâãäå]/g,"a"),e=e.replace(/[ÉÈÊË]/g,"E"),e=e.replace(/[éèêë]/g,"e"),e=e.replace(/[ÍÌÎÏ]/g,"I"),e=e.replace(/[íìîï]/g,"i"),e=e.replace(/[ÓÒÔÕ]/g,"O"),e=e.replace(/[óòôõ]/g,"o"),e=e.replace(/[ÚÙÛÜ]/g,"U"),e=e.replace(/[úùûü]/g,"u"),e=e.replace(/[Ç]/g,"C"),e=e.replace(/[ç]/g,"c")}function o(e,a){var o;$("#loading").removeClass("hide"),$("#resultadoconsulta_formato_dados").hide(),a?(type_http="POST",o=O):(type_http="GET",o=null),$.ajax({url:e,type:type_http,dataType:"json",data:o,error:function(e){console.log("Erro no ajax: "+e)},success:function(e){if("Nenhuma Organização encontrada!"!==e){var a=e.length,o=new Array(a),t=0,n="Dado não informado.";for(var r in e)if("0"!=r){o[t]=new Array(6);var i=null!==e[r][4]?e[r][4]:"img/camera.jpg";o[t][0]='<img class="img-circle media-object" src='+i+' height="64" width="64">',o[t][1]=null!==e[r][0]?e[r][0]:n,o[t][2]=null!==e[r][1]?e[r][1]:n,o[t][3]=null!==e[r][2]?e[r][2]:n,o[t][4]=null!==e[r][3]?e[r][3]:n,o[t][5]='<button type="button" onclick="location.href=\'visualizar-osc.html#'+r+'\';" class="btn btn-info"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button>',t++}if(void 0!==o[0]){var l=$("#resultadoconsulta_formato_dados").DataTable({responsive:!0,processing:!0,deferLoading:1e3,deferRender:!0,searching:!1,data:o,dom:"Bfrtip",bPaginate:!1,bSort:!0,aaSorting:[[1,"asc"]],columns:[{title:"",width:50},{title:"Nome da OSC",width:200},{title:"CNPJ"},{title:"Natureza Jurídica"},{title:"Endereço"},{title:"Detalhar"}],aoColumnDefs:[{bSortable:!1,aTargets:[0]},{bSortable:!1,aTargets:[5]},{bSortable:!1,aTargets:[4]}],autoWidth:!0});l.destroy(),l.draw(),$("#resultadoconsulta_formato_dados").show(),$("#loading").addClass("hide")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==z&&"municipio"!==z?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(N)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==z&&"municipio"!==z?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(N)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}}),$("#resultadoconsulta_formato_dados").on("draw.dt",function(){verificarContraste()})}function t(e){for(var a in e)if("0"!=a){var o=function(e,a,o){if(""!==a&&null!==a||null!==o&&""!==o){var t=new PruneCluster.Marker(a,o);return t.data.ID=e,A.PrepareLeafletMarker=function(e,a){e.on("click",function(){!function(e,a){a.bindPopup('<img id="loading" src="img/loading.gif" style="padding-top: 10px; padding-left: 10px;"/>').openPopup(),$.ajax({url:D.OSCPopUpByID(e),type:"GET",dataType:"json",error:function(e){console.log("ERRO no AJAX :"+e)},success:function(o){if(void 0!==o){var t=(null!==o.tx_endereco?o.tx_endereco:"")+" - "+(null!==o.tx_bairro?o.tx_bairro:""),n='<div class="mapa_organizacao clearfix"><span id="spantitle" class="magneticTooltip"><button id="title" class="btn-link"  onclick=location.href="visualizar-osc.html#'+e+'"><h4>'+(null!==o.tx_nome_osc?o.tx_nome_osc:"Dado não informado.")+'</h4></button></span><div class="coluna1"><strong></strong><strong>Endereço: </strong>'+t+"<br><strong>Atividade Econômica: </strong>"+(null!==o.tx_nome_atividade_economica?o.tx_nome_atividade_economica:"Dado não informado.")+"<br><strong>Natureza Jurídica: </strong>"+(null!==o.tx_nome_natureza_juridica?o.tx_nome_natureza_juridica:"Dado não informado.")+'<br><br><div align="center"><button type = button class="btn btn-info" onclick=location.href="visualizar-osc.html#'+e+'"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Detalhar</button></div></div></div>';a.bindPopup(n).openPopup()}}})}(a.ID,e)})},A.RegisterMarker(t),A}return null}(a,e[a][0],e[a][1]);null!==o&&M.addLayer(o)}$("#loadingMapModal").hide(),A.ProcessView()}function n(e){var a=e.target;a.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||a.bringToFront(),"GO"==a.feature.properties.Name&&a.bringToBack(),J.update(a.feature.properties)}function r(e){u.resetStyle(e.target),J.update()}function i(e){var a=e.target;M.fitBounds(a.getBounds())}function l(e){return e>6e4?"#800026":e>45e3?"#E31A1C":e>3e4?"#FC4E2A":e>15e3?"#FEB24C":e>1e3?"#FED976":"#FFEDA0"}function s(e,a){var l;"regiao"==a||"todos"==a?l="labelClassRegiao":"estado"==a&&(l="labelClassEstado");for(var u in e){var d=L.divIcon({id:e[u].id_regiao,className:l,html:"<p>"+e[u].nr_quantidade_osc_regiao+"</p>"});g[e[u].id_regiao]=e[u].nr_quantidade_osc_regiao;var p=function(e,a,l,u,d){if(""!==l&&null!==l||null!==u&&""!==u){var p;return"regiao"==d||"todos"==d?p=L.marker([l,u],{icon:e}).on("click",function(e){var a=e.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:D.ClusterEstadoPorRegiao(a),type:"GET",dataType:"json",error:function(e){console.log("ERRO no AJAX :"+e)},success:function(t){if(o(urlRota,b),void 0!==t.length){for(var n=0,r=0;r<t.length;r++)n+=t[r].nr_quantidade_osc_regiao;c(n)}else c(Object.keys(t).length-1);void 0!==t&&(M.setView([e.target._latlng.lat,e.target._latlng.lng],5),M.removeLayer(e.target),delete h[a],s(t,"estado"))}})}):"estado"==d&&(p=L.marker([l,u],{icon:e}).on("click",function(e){var a=e.target.options.icon.options.id;$("#loadingMapModal").show(),$.ajax({url:D.OSCByStateInMap(a),type:"GET",dataType:"json",error:function(e){console.log("ERRO no AJAX :"+e)},success:function(l){if(o(urlRota,b),void 0!==l.length){for(var s=0,u=0;u<l.length;u++)s+=l[u].nr_quantidade_osc_regiao;c(s)}else c(Object.keys(l).length-1);if(void 0!==l){M.setView([e.target._latlng.lat,e.target._latlng.lng],6),M.removeLayer(e.target);var d=m[a];d.off(),d.on({mouseover:n,mouseout:r,click:i}),t(l)}}})})),p}}(d,e[u].id_regiao,e[u].geo_lat_centroid_regiao,e[u].geo_lng_centroid_regiao,a);v.addLayer(p),"estado"==a?f[e[u].id_regiao]=p:"regiao"!=a&&"todos"!=a||(h[e[u].id_regiao]=p)}y||(v.addTo(M),y=!0),$("#loadingMapModal").hide()}function c(e){$(".pagination").pagination({items:e,itemsOnPage:10,hrefTextPrefix:"#",prevText:"Anterior",nextText:"Próximo",onPageClick:function(e){!function(e){null===e&&(e=0);var a=10*parseInt(e)-10;"avancado"==z?(urlRota=D.ConsultaAvancadaLista(a),b=!0):"municipio"==z?urlRota=D.OSCByCounty(N,a):"estado"==z?urlRota=D.OSCByState(N,a):"regiao"==z?urlRota=D.OSCByRegion(N,a):"todos"==z?urlRota=D.AllOSC(a):"organizacao"==z&&(urlRota=D.OSCByName(getParameter("organizacao"),a,getParameter("tipoBusca")));o(urlRota,b)}(e)}})}var u,d,p,g={},m={},f={},h={},v=L.layerGroup(),_=L.layerGroup(),y=!1,C=!0,b=!1,x=!1,S="",O={},R="",T=18,w={center:new L.LatLng(-16.55555555,-60.55555555),zoom:4,minZoom:4},M=new L.Map("map",w),A=new PruneClusterForLeaflet,E=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:T,attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>'}),j=L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYW9zY3MiLCJhIjoiY2owbDJpYWxwMDM3dTMzbzh6dDU2bnpzdyJ9._dh2UCWnAeNeG0ZL5sQ5gA",{id:"mapbox.dark",attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'}),k=L.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});M.addLayer(k),M.addLayer(j),M.addLayer(E);var P=new L.Control.FullScreen;M.addControl(P);var B,z,D=new Rotas,q=void 0!==window.location.href.split("?")[1]?window.location.href.split("?")[1].split("="):null,I=$("#buscarPerfil .tab-content");if(I.find(".btn.btn-primary").on("click",function(){var e=I.find(".tab-pane.fade.active.in"),o=e.attr("id"),t=e.find(".form-control").val();t=a(t.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,",").replace(/\+{2,}/g,"_"),"organizacao"==o&&""!==t?(d="./resultado-consulta.html?"+o+"="+t+"&tipoBusca=0",location.href=d):""!==(t=$(".response").val())?(d="./resultado-consulta.html?"+o+"="+t,location.href=d):$("#errorLabel").removeClass("hide")}),$("#organizacao .form-control").autocomplete({minLength:3,source:function(e,o){R=a(e.term.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),$.ajax({url:D.AutocompleteOSCByName(R,10,0),type:"GET",dataType:"json",success:function(e){o($.map(e,function(e){return{label:e.tx_nome_osc,value:e.tx_nome_osc,id:e.id_osc}}))},error:function(e){o([])}})},select:function(e,o){d="./resultado-consulta.html?organizacao="+a(o.item.value.trim()).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,",").replace(/\+{2,}/g,"_")+"&tipoBusca=1",location.href=d}}),$("#municipio .form-control").autocomplete({minLength:3,source:function(e,o){$.ajax({url:D.AutocompleteOSCByCounty(a(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),25),type:"GET",dataType:"json",success:function(e){o($.map(e,function(e){return{label:e.edmu_nm_municipio+" - "+e.eduf_sg_uf,value:e.edmu_nm_municipio+" - "+e.eduf_sg_uf,id:e.edmu_cd_municipio}}))},error:function(e){o([])}})},select:function(e,a){$(".response").val(a.item.id),d="./resultado-consulta.html?municipio="+a.item.id,location.href=d}}),$("#estado .form-control").autocomplete({minLength:3,source:function(e,o){$.ajax({url:D.AutocompleteOSCByState(a(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),10),type:"GET",dataType:"json",success:function(e){o($.map(e,function(e){return{label:e.eduf_nm_uf,value:e.eduf_nm_uf,id:e.eduf_cd_uf}}))},error:function(){o([])}})},select:function(e,a){$(".response").val(a.item.id),d="./resultado-consulta.html?estado="+a.item.id,location.href=d}}),$("#regiao .form-control").autocomplete({minLength:3,source:function(e,o){$.ajax({url:D.AutocompleteOSCByRegion(a(e.term).replace(/ /g,"_").replace(/[\/|\\|\||:|#|@|$|&|!|?|(|)|\[|\]]/g,"").replace(/\./g,","),10),type:"GET",dataType:"json",success:function(e){o($.map(e,function(e){return{label:e.edre_nm_regiao,value:e.edre_nm_regiao,id:e.edre_cd_regiao}}))},error:function(){o([])}})},select:function(e,a){$(".response").val(a.item.id),d="./resultado-consulta.html?regiao="+a.item.id,location.href=d}}),$(".ui-autocomplete-input").keypress(function(e){if(13==e.which)return $(".btn-primary").click(),$(".ui-menu-item").hide(),!1}),null!==q){z=q[0];var N=q[1];N=N.replace(/\./g,""),N=N.split("&")[0],"organizacao"==z?(urlRota=D.OSCByName(getParameter("organizacao"),0,getParameter("tipoBusca")),B=D.OSCByNameInMap(getParameter("organizacao"),getParameter("tipoBusca")),C=!1,x=!0):"municipio"==z?(urlRota=D.OSCByCounty(N,0),B=D.OSCByCountyInMap(N),C=!1,x=!0,p=N,S="do município "):"estado"==z?(urlRota=D.OSCByState(N,0),B=D.ClusterEstadoPorRegiao(N),x=!0,p=N,S="do estado "):"regiao"==z?(urlRota=D.OSCByRegion(N,0),B=D.ClusterRegiao(N),x=!0,p=N,S="da região "):"avancado"==z?(O.avancado=window.localStorage.getItem("params_busca_avancada"),"{}"==O.avancado?(z="todos",B=D.ClusterPais(),urlRota=D.AllOSC(0)):(urlRota=D.ConsultaAvancadaLista(0),B=D.ConsultaAvancadaMapa(),C=!1,b=!0)):console.log("ERRO de URL!")}else z="todos",B=D.ClusterPais(),urlRota=D.AllOSC(0);if(x){var G="Análise "+S;$("#analisePerfil").text(G),$("#analisePerfil").attr("href","analise-perfil.html?localidade="+p)}var J=L.control();$("#loadingMapModal").show();var F;b?(type_http="POST",F=O):(type_http="GET",F=null),$.ajax({url:B,type:type_http,dataType:"json",data:F,error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(""!==e&&void 0!==e&&"Nenhuma Organização encontrada!"!==e){o(urlRota,b);var a=0;if(C){if(void 0!==e.length)for(var n=0;n<e.length;n++)a+=e[n].nr_quantidade_osc_regiao;c(a),$("#legenda p").append(a),s(e,z)}else c(a=Object.keys(e).length-1),$("#legenda p").append(a),t(e)}else $("#modalMensagem").modal({backdrop:"static",keyboard:!1}),$("#modalTitle").text("Nenhuma OSC encontrada!"),"avancado"!==z&&"municipio"!==z?$("#modalConteudo").text('Sua pesquisa "'+decodeURIComponent(N)+'" não retornou nenhuma OSC.'):$("#modalConteudo").text("Sua pesquisa não retornou nenhuma OSC."),$("#modalMensagem").modal("show")}}),$.ajax({url:D.ClusterEstado(),type:"GET",dataType:"json",error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(void 0!==e){var a={},d={};for(var p in e)a[e[p].tx_sigla_regiao]=e[p].nr_quantidade_osc_regiao,d[e[p].tx_sigla_regiao]=e[p].id_regiao;M.addControl(new L.Control.Layers({"Satélite":k,Contraste:j,Mapa:E},{"Mapa de calor":_},{collapsed:!1})),function(e,a){var d;$.each(statesData.features,function(o){d=statesData.features[o].properties.Name,statesData.features[o].properties.density=e[d],statesData.features[o].properties.id=a[d]}),M.addLayer(_),J.onAdd=function(e){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},J.update=function(e){this._div.innerHTML="<h4>OSCs por Estado</h4>"+(e?"<b>"+e.Name+"</b><br />"+e.density+" OSCs.":"Passe o mouse sobre um estado")},J.addTo(M);var p=L.control({position:"bottomright"});p.onAdd=function(e){var a=L.DomUtil.create("div","info legend"),o=[0,1e3,15e3,3e4,45e3,6e4];a.innerHTML+="<h5>Escala de OSCs por estado</h5>";for(var t=0;t<o.length;t++)a.innerHTML+='<i style="background:'+l(o[t]+1)+'"></i> '+parseInt(o[t]+1)+(o[t+1]?"&ndash;"+o[t+1]+"<br>":"+");return a},p.addTo(M),u=L.geoJson(statesData,{style:function(e){return{fillColor:l(e.properties.density),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.6}},onEachFeature:function(e,a){a.on({mouseover:n,mouseout:r,click:function(e){var a=e.target;if(M.fitBounds(a.getBounds()),function(e){$("#loadingMapModal").show(),$.ajax({url:D.OSCByStateInMap(e),type:"GET",dataType:"json",error:function(e){console.log("ERRO no AJAX :"+e)},success:function(e){if(o(urlRota,b),void 0!==e.length){for(var a=0,n=0;n<e.length;n++)a+=e[n].nr_quantidade_osc_regiao;c(a)}else c(Object.keys(e).length-1);void 0!==e&&t(e)}})}(a.feature.properties.id),void 0==h[a.feature.properties.Regiao]){var l=f[a.feature.properties.id];void 0!=l&&M.removeLayer(l)}else!function(e){var a=e.feature.properties.Regiao;$("#loadingMapModal").show(),$.ajax({url:D.ClusterEstadoPorRegiao(a),type:"GET",dataType:"json",error:function(e){console.log("ERRO no AJAX :"+e)},success:function(t){if(o(urlRota,b),void 0!==t.length){for(var n=0,r=0;r<t.length;r++)n+=t[r].nr_quantidade_osc_regiao;c(n)}else c(Object.keys(t).length-1);if(void 0!==t){s(t,"estado");var i=h[a];M.removeLayer(i),delete h[a];var l=f[e.feature.properties.id];M.removeLayer(l)}}})}(a);a.off(),a.on({mouseover:n,mouseout:r,click:i})}}),_.addLayer(a),m[a.feature.properties.id]=a}}).addTo(M)}(a,d)}}}),M.on("zoomend",function(e){M.getZoom()==T&&M.removeLayer(_)})});